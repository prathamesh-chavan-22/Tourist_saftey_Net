<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Map - {{ tourist.name }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/css/map.css" />
</head>
<body class="{% if current_user.role == 'admin' %}admin-theme{% else %}tourist-theme{% endif %}">
    <div class="header {% if current_user.role == 'admin' %}admin-theme{% else %}tourist-theme{% endif %}">
        <h1>🇮🇳 Tourist Map - {{ tourist.name }}</h1>
        <p><strong>Location:</strong> {{ geofence.name }} | <strong>Safe Zone:</strong> {{ geofence.radius }}m radius</p>
        {% if current_user.role == "admin" %}
        <div style="background-color: #ffc107; color: #212529; padding: 10px; border-radius: 4px; margin: 10px 0; font-weight: bold;">
            👁️ <strong>Admin View - Read Only</strong> | You are viewing this tourist's location without control access
        </div>
        <p>Admin view: You can monitor the tourist's status and location but cannot control movement</p>
        {% else %}
        <p>Use arrow keys (↑↓←→) to move around and monitor your safety status in real-time</p>
        {% endif %}
        <a href="/" class="dashboard-link">← Back to Dashboard</a>
    </div>

    <div class="status-panel">
        <div class="status-item">
            <h3>Current Status</h3>
            <div id="status" class="status-{{ tourist.status|lower }}">{{ tourist.status }}</div>
        </div>
        <div class="status-item">
            <h3>Your Location</h3>
            <div id="coordinates">{{ "%.4f"|format(tourist.last_lat) }}, {{ "%.4f"|format(tourist.last_lon) }}</div>
        </div>
        <div class="status-item">
            <h3>Trip ID</h3>
            <div>{{ tourist.id }}</div>
        </div>
    </div>

    <!-- Guide Information Panel -->
    <div id="guideInfoPanel" class="guide-info-panel" style="display: none;">
        <h3>🧭 Your Assigned Guide</h3>
        <div class="guide-info-grid">
            <div class="guide-info-item">
                <strong>Name:</strong>
                <span id="guideName">--</span>
            </div>
            <div class="guide-info-item">
                <strong>Status:</strong>
                <span id="guideStatus">--</span>
            </div>
            <div class="guide-info-item">
                <strong>Location:</strong>
                <span id="guideCoordinates">--</span>
            </div>
            <div class="guide-info-item">
                <strong>Last Updated:</strong>
                <span id="guideUpdated">--</span>
            </div>
        </div>
        <div class="guide-note">
            <small>🔵 Your guide's location is shown with a purple "G" marker on the map</small>
        </div>
    </div>

    <div id="alertContainer">
        <div id="warningAlert" class="alert alert-warning">
            ⚠️ <strong>Warning!</strong> You are outside the safe zone. Please return to the designated area.
        </div>
        <div id="safeAlert" class="alert alert-success">
            ✅ <strong>Safe!</strong> You are within the protected area.
        </div>
    </div>

    <div class="map-container">
        <h3>Live Location Map</h3>
        <div id="map"></div>
    </div>

    {% if current_user.role != "admin" %}
    <div class="controls-panel">
        <h3>Movement Controls</h3>
        <p>Use the arrow keys on your keyboard or click the buttons below to move:</p>
        
        <div class="arrow-keys">
            <button class="arrow-key arrow-up" data-direction="up">↑</button>
            <button class="arrow-key arrow-left" data-direction="left">←</button>
            <button class="arrow-key arrow-down" data-direction="down">↓</button>
            <button class="arrow-key arrow-right" data-direction="right">→</button>
        </div>
        
        <div class="movement-info">
            <small>Each movement step is approximately 0.001 degrees (~111 meters)</small><br>
            <small><strong>SIH 2025 PS-2:</strong> Smart Tourist Safety Monitoring System</small>
        </div>
    </div>
    {% endif %}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="/static/js/map.js"></script>
    <script>
        // Initialize map with template data
        const touristData = {
            id: {{ tourist.id }},
            name: "{{ tourist.name }}",
            lat: {{ tourist.last_lat }},
            lon: {{ tourist.last_lon }},
            status: "{{ tourist.status }}",
            trip_id: {{ trip.id }}
        };
        
        const geofenceData = {
            centerLat: {{ geofence.center_lat }},
            centerLon: {{ geofence.center_lon }},
            radius: {{ geofence.radius }},
            name: "{{ geofence.name }}"
        };
        
        const userRole = "{{ current_user.role }}";
        
        // Initialize the map with all data
        initializeMap(touristData, geofenceData, userRole);
    </script>
</body>
</html>