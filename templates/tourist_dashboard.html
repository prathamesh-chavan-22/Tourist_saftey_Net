<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tourist Dashboard - {{ user.full_name }}</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="/static/css/tourist.css" />
</head>
<body>
    <div class="header">
        <div class="header-left">
            <h1>üáÆüá≥ Tourist Safety Dashboard</h1>
            <p>Welcome, {{ user.full_name }}!</p>
        </div>
        <div class="header-right">
            <div class="user-info">
                <strong>{{ user.email }}</strong><br>
                <small>Tourist Account</small>
            </div>
            <form method="post" action="/auth/logout" style="margin: 0;">
                <button type="submit" class="logout-btn">Logout</button>
            </form>
        </div>
    </div>

    {% if error %}
    <div class="alert alert-danger">
        {{ error }}
    </div>
    {% endif %}

    {% if message %}
    <div class="alert alert-success">
        {{ message }}
    </div>
    {% endif %}

    <!-- Active Trip Status Panel -->
    {% if active_trip %}
    <div class="single-panel">
        <h3>üó∫Ô∏è Active Trip Status</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; text-align: center;">
            <div>
                <h4>Status</h4>
                <div class="status-value status-{{ active_trip.status|lower }}">{{ active_trip.status }}</div>
            </div>
            <div>
                <h4>Location</h4>
                <div class="status-value">{{ "%.4f"|format(active_trip.last_lat) }}, {{ "%.4f"|format(active_trip.last_lon) }}</div>
            </div>
            <div>
                <h4>Destination</h4>
                <div class="status-value">{{ active_trip.tourist_destination_name }}</div>
            </div>
            <div>
                <h4>Trip ID</h4>
                <div class="status-value">{{ active_trip.id }}</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content -->
    {% if active_trip %}
    <div class="content">
        <!-- Active Trip Panel -->
        <div class="trip-panel">
            <h3>üìç Current Trip Details</h3>
            <table class="trip-table">
                <tr>
                    <td><strong>Blockchain ID:</strong></td>
                    <td>{{ active_trip.blockchain_id }}</td>
                </tr>
                <tr>
                    <td><strong>Starting Location:</strong></td>
                    <td>{{ active_trip.starting_location }}</td>
                </tr>
                <tr>
                    <td><strong>Destination:</strong></td>
                    <td>{{ active_trip.tourist_destination_name }}</td>
                </tr>
                <tr>
                    <td><strong>Hotels:</strong></td>
                    <td>{{ active_trip.hotels or "Not specified" }}</td>
                </tr>
                <tr>
                    <td><strong>Travel Mode:</strong></td>
                    <td>{{ active_trip.mode_of_travel }}</td>
                </tr>
                <tr>
                    <td><strong>Status:</strong></td>
                    <td><span class="status-{{ active_trip.status|lower }}">{{ active_trip.status }}</span></td>
                </tr>
            </table>
            
            <div style="margin-top: 20px; text-align: center;">
                <a href="/trip/{{ active_trip.id }}" class="trip-link">View Live Map</a>
                
                <form method="post" action="/close-trip" style="display: inline-block; margin-left: 10px;">
                    <input type="hidden" name="trip_id" value="{{ active_trip.id }}">
                    <button type="submit" class="close-trip-btn" onclick="return confirm('Are you sure you want to close this trip?')">Close Trip</button>
                </form>
            </div>
        </div>

        <!-- Map Panel -->
        <div class="map-panel">
            <h3>üó∫Ô∏è Your Location</h3>
            <div id="map"></div>
        </div>

        <!-- Movement Controls Panel -->
        <div class="controls-panel">
            <h3>üéÆ Movement Controls</h3>
            <p>Use arrow keys on your keyboard or click the buttons below:</p>
            
            <div class="arrow-keys" style="display: grid; grid-template-columns: repeat(3, 50px); gap: 5px; justify-content: center; margin: 20px 0;">
                <div></div>
                <button class="arrow-key" data-direction="up" style="padding: 10px; font-size: 18px; border: 2px solid #007bff; background: #f8f9fa; border-radius: 4px; cursor: pointer;">‚Üë</button>
                <div></div>
                <button class="arrow-key" data-direction="left" style="padding: 10px; font-size: 18px; border: 2px solid #007bff; background: #f8f9fa; border-radius: 4px; cursor: pointer;">‚Üê</button>
                <button class="arrow-key" data-direction="down" style="padding: 10px; font-size: 18px; border: 2px solid #007bff; background: #f8f9fa; border-radius: 4px; cursor: pointer;">‚Üì</button>
                <button class="arrow-key" data-direction="right" style="padding: 10px; font-size: 18px; border: 2px solid #007bff; background: #f8f9fa; border-radius: 4px; cursor: pointer;">‚Üí</button>
            </div>
            
            <div style="text-align: center; margin-top: 10px;">
                <small>Each step moves approximately 111 meters</small>
            </div>
        </div>
    </div>
    {% else %}
    <!-- No Active Trip -->
    <div class="single-panel" style="text-align: center;">
        <h3>üß≥ No Active Trip</h3>
        <p>You don't have any active trips. Create a new trip to start tracking your location and ensure your safety during travel.</p>
        <a href="/create-trip" class="create-trip-btn">üöÄ Create New Trip</a>
    </div>
    {% endif %}

    <!-- Past Trips -->
    {% if past_trips %}
    <div class="single-panel">
        <h3>üìö Trip History ({{ past_trips|length }})</h3>
        <table class="trip-table">
            <thead>
                <tr>
                    <th>Destination</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Duration</th>
                    <th>Final Status</th>
                </tr>
            </thead>
            <tbody>
                {% for trip in past_trips %}
                <tr>
                    <td>{{ trip.tourist_destination_name }}</td>
                    <td>{{ trip.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>{{ trip.closed_at.strftime('%Y-%m-%d') if trip.closed_at else 'N/A' }}</td>
                    <td>
                        {% if trip.closed_at %}
                            {{ (trip.closed_at - trip.created_at).days }} days
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td><span class="status-inactive">Completed</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        {% if active_trip %}
        // Initialize current coordinates for movement tracking
        let currentLat = {{ active_trip.last_lat }};
        let currentLon = {{ active_trip.last_lon }};
        
        // Initialize map for active trip
        const map = L.map('map').setView([currentLat, currentLon], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add geofence circle
        L.circle([{{ geofence.center_lat }}, {{ geofence.center_lon }}], {
            color: 'green',
            fillColor: '#90EE90',
            fillOpacity: 0.2,
            radius: {{ geofence.radius }}
        }).addTo(map).bindPopup('<b>{{ geofence.name }}</b><br>Safe Zone: {{ geofence.radius }}m radius');
        
        // Add current location marker
        const marker = L.marker([{{ active_trip.last_lat }}, {{ active_trip.last_lon }}])
            .addTo(map)
            .bindPopup('<b>Your Current Location</b><br>Status: {{ active_trip.status }}')
            .openPopup();
        
        // WebSocket for real-time updates
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.host;
        const ws = new WebSocket(`${wsProtocol}//${wsHost}/ws/location`);
        
        ws.onopen = function(event) {
            console.log('WebSocket connection established');
        };
        
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            console.log('WebSocket message received:', data);
            
            if (data.type === 'location_update' && data.trip_id === {{ active_trip.id }}) {
                // Update current coordinates for movement tracking
                currentLat = data.latitude;
                currentLon = data.longitude;
                
                // Update marker position
                marker.setLatLng([data.latitude, data.longitude]);
                marker.setPopupContent(`<b>Your Current Location</b><br>Status: ${data.status}`);
                
                // Update status on page
                document.querySelectorAll('.status-value').forEach(elem => {
                    if (elem.textContent.includes('Safe') || elem.textContent.includes('Critical')) {
                        elem.textContent = data.status;
                        elem.className = `status-value status-${data.status.toLowerCase()}`;
                    }
                });
                
                // Update coordinates
                document.querySelectorAll('.status-value').forEach(elem => {
                    if (elem.textContent.includes(',')) {
                        elem.textContent = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
                    }
                });
            }
        };
        
        ws.onerror = function(error) {
            console.error('WebSocket error:', error);
        };
        
        ws.onclose = function(event) {
            console.log('WebSocket connection closed');
            setTimeout(() => {
                console.log('Attempting to reconnect...');
                location.reload(); // Simple reconnect strategy
            }, 3000);
        };

        // Movement functionality
        function showAlert(message, type) {
            const alertElement = document.getElementById('statusAlert');
            if (!alertElement) {
                // Create alert element if it doesn't exist
                const newAlert = document.createElement('div');
                newAlert.id = 'statusAlert';
                newAlert.className = 'alert';
                newAlert.style.display = 'none';
                newAlert.style.position = 'fixed';
                newAlert.style.top = '20px';
                newAlert.style.left = '50%';
                newAlert.style.transform = 'translateX(-50%)';
                newAlert.style.zIndex = '1000';
                newAlert.style.padding = '10px 20px';
                newAlert.style.borderRadius = '4px';
                document.body.appendChild(newAlert);
            }
            const alert = document.getElementById('statusAlert');
            alert.textContent = message;
            alert.className = `alert alert-${type}`;
            
            // Set alert colors
            if (type === 'success') {
                alert.style.backgroundColor = '#d4edda';
                alert.style.color = '#155724';
                alert.style.border = '1px solid #c3e6cb';
            } else if (type === 'warning') {
                alert.style.backgroundColor = '#fff3cd';
                alert.style.color = '#856404';
                alert.style.border = '1px solid #ffeaa7';
            } else if (type === 'danger') {
                alert.style.backgroundColor = '#f8d7da';
                alert.style.color = '#721c24';
                alert.style.border = '1px solid #f5c6cb';
            }
            
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        async function moveLocation(direction) {
            {% if not active_trip %}
            showAlert('No active trip! Create a trip first to use movement controls.', 'warning');
            return;
            {% endif %}

            const moveDistance = 0.001; // Movement step
            let newLat = currentLat;
            let newLon = currentLon;
            
            switch(direction) {
                case 'up': newLat += moveDistance; break;
                case 'down': newLat -= moveDistance; break;
                case 'left': newLon -= moveDistance; break;
                case 'right': newLon += moveDistance; break;
            }
            
            try {
                const response = await fetch('/update_location', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        trip_id: {{ active_trip.id if active_trip else 'null' }},
                        latitude: newLat,
                        longitude: newLon
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to update location');
                }
                
                const data = await response.json();
                updateLocationOnMap(newLat, newLon, data.status);
                showAlert(data.inside_fence ? 'You are in the safe zone!' : 'Warning: You have left the safe zone!', 
                         data.inside_fence ? 'success' : 'warning');
                
            } catch (error) {
                console.error('Error updating location:', error);
                showAlert('Failed to update location. Please try again.', 'danger');
            }
        }

        function updateLocationOnMap(lat, lon, status) {
            {% if active_trip %}
            currentLat = lat;
            currentLon = lon;
            
            // Update marker position
            marker.setLatLng([lat, lon]);
            
            // Update status display
            document.querySelectorAll('.status-value').forEach(elem => {
                if (elem.textContent.includes('Safe') || elem.textContent.includes('Critical') || elem.textContent.includes('Warning')) {
                    elem.textContent = status;
                    elem.className = `status-value status-${status.toLowerCase()}`;
                }
            });
            
            // Update coordinates display
            document.querySelectorAll('.status-value').forEach(elem => {
                if (elem.textContent.includes(',')) {
                    elem.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
                }
            });
            {% endif %}
        }

        // Arrow key controls
        document.addEventListener('keydown', function(event) {
            if (event.code === 'ArrowUp') {
                event.preventDefault();
                moveLocation('up');
            } else if (event.code === 'ArrowDown') {
                event.preventDefault();
                moveLocation('down');
            } else if (event.code === 'ArrowLeft') {
                event.preventDefault();
                moveLocation('left');
            } else if (event.code === 'ArrowRight') {
                event.preventDefault();
                moveLocation('right');
            }
        });

        // Button controls (if arrow key buttons exist)
        document.querySelectorAll('.arrow-key').forEach(button => {
            button.addEventListener('click', function() {
                const direction = this.getAttribute('data-direction');
                moveLocation(direction);
            });
        });
        {% endif %}
    </script>
</body>
</html>